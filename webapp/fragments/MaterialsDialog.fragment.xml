<core:FragmentDefinition xmlns="sap.m" xmlns:core="sap.ui.core" xmlns:table="sap.ui.table">
  <Dialog id="dlgMateriais"
          icon="sap-icon://wrench"
          contentWidth="auto"
          horizontalScrolling="false">

    <customHeader>
      <Bar>
        <contentLeft>
          <core:Icon src="sap-icon://wrench" size="1.5rem"/>
          <Title text="{dlg>/titulo}" level="H2"/>
        </contentLeft>
        <contentRight>
          <Button icon="sap-icon://decline" type="Transparent" press=".onCloseMateriais"/>
        </contentRight>
      </Bar>
    </customHeader>

    <content>
      <VBox renderType="Bare">
        <!-- Tabela desktop com sortProperty e filtros por coluna -->
        <table:Table id="tblMatGrid"
                     rows="{dlg>/materiais}"
                     selectionMode="None"
                     enableColumnReordering="true"
                     enableBusyIndicator="true"
                     rowHeight="32"
                     columnHeaderHeight="36"
                     width="100%"
                     visibleRowCountMode="Auto"
                     minAutoRowCount="10"
                     fixedColumnCount="2">

          <!-- Item (nome) | alinhado à esquerda -->
          <table:Column width="24rem" sortProperty="nome" filterProperty="nome" hAlign="Begin">
            <Label text="Item" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>nome}" tooltip="{dlg>nome}" wrapping="true"/>
            </table:template>
          </table:Column>

          <!-- Tipo | center -->
          <table:Column width="4rem" sortProperty="tipo" filterProperty="tipo" hAlign="Center">
            <Label text="Tipo" textAlign="Center" width="100%"/>
            <table:template>
              <ObjectStatus
                text="{path:'dlg>tipo', formatter:'.formatter.getTipoText'}"
                class="{path:'dlg>tipo', formatter:'.formatter.getTipoClass'}"
                tooltip="{dlg>tipo}"/>
            </table:template>
          </table:Column>

          <!-- Qtde | numérico direita -->
          <table:Column width="4rem" sortProperty="qtde" filterProperty="qtde" hAlign="End">
            <Label text="Qtde" textAlign="Center" width="100%"/>
            <table:template>
              <ObjectNumber number="{dlg>qtde}"/>
            </table:template>
          </table:Column>

          <!-- Unid | center -->
          <table:Column width="3rem" sortProperty="unid" filterProperty="unid" hAlign="Center">
            <Label text="Unid" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>unid}"/>
            </table:template>
          </table:Column>

          <!-- Custo Unit. | numérico direita -->
          <table:Column width="6rem" sortProperty="custoUnit" filterProperty="custoUnit" hAlign="End">
            <Label text="Custo Unit." textAlign="Center" width="100%"/>
            <table:template>
              <ObjectNumber number="{path:'dlg>custoUnit', formatter:'.formatter.fmtBrl'}"/>
            </table:template>
          </table:Column>

          <!-- Total (R$) | numérico direita (usa totalItem calculado no controller) -->
          <table:Column width="6rem" sortProperty="totalItem" filterProperty="totalItem" hAlign="End">
            <Label text="Total (R$)" textAlign="Center" width="100%"/>
            <table:template>
              <ObjectNumber number="{path:'dlg>totalItem', formatter:'.formatter.fmtBrl'}"/>
            </table:template>
          </table:Column>

          <!-- Status | center -->
          <table:Column width="7rem" hAlign="Center">
            <Label text="Status" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="DEVOLUÇÃO"
                    visible="{path:'dlg>qtde', formatter:'.formatter.isDevolucao'}"
                    class="blinkingText"/>
            </table:template>
          </table:Column>

          <!-- Cód. Material | texto monospace opcional (evita quebra) -->
          <table:Column width="4rem" sortProperty="codMaterial" filterProperty="codMaterial" hAlign="Center">
            <Label text="Cód. Material" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>codMaterial}" tooltip="{dlg>codMaterial}"/>
            </table:template>
          </table:Column>

          <!-- Depósito | center -->
          <table:Column width="4rem" sortProperty="deposito" filterProperty="deposito" hAlign="Center">
            <Label text="Depósito" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>deposito}"/>
            </table:template>
          </table:Column>

          <!-- Hora | center -->
          <table:Column width="6rem" sortProperty="horaEntrada" filterProperty="horaEntrada" hAlign="Center">
            <Label text="Hora" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{path:'dlg>horaEntrada', formatter:'.formatter.fmtHora'}"/>
            </table:template>
          </table:Column>

          <!-- Data | center (usa sua formatter de UTC-aware) -->
          <table:Column width="6rem" sortProperty="data" filterProperty="data" hAlign="Center">
            <Label text="Data" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{parts: [{path: 'dlg>data'}, {path: 'dlg>budat_mkpf'}], formatter:'.formatter.fmtDateUtcAware'}"/>
            </table:template>
          </table:Column>

          <!-- N. Ordem | direita para números longos -->
          <table:Column width="5rem" sortProperty="nOrdem" filterProperty="nOrdem" hAlign="End">
            <Label text="N. Ordem" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>nOrdem}" tooltip="{dlg>nOrdem}"/>
            </table:template>
          </table:Column>

          <!-- N. Reserva | direita -->
          <table:Column width="6rem" sortProperty="nReserva" filterProperty="nReserva" hAlign="End">
            <Label text="N. Reserva" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>nReserva}" tooltip="{dlg>nReserva}"/>
            </table:template>
          </table:Column>

          <!-- Recebedor | esquerda com wrap -->
          <table:Column width="7rem" sortProperty="recebedor" filterProperty="recebedor" hAlign="Begin">
            <Label text="Recebedor" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>recebedor}" tooltip="{dlg>recebedor}" wrapping="true"/>
            </table:template>
          </table:Column>

          <!-- Usuário | esquerda -->
          <table:Column width="7rem" sortProperty="usuario" filterProperty="usuario" hAlign="Begin">
            <Label text="Usuário" textAlign="Center" width="100%"/>
            <table:template>
              <Text text="{dlg>usuario}" tooltip="{dlg>usuario}"/>
            </table:template>
          </table:Column>

        </table:Table>

        <Toolbar class="sapUiTinyMarginTop">
          <ToolbarSpacer/>
          <ObjectStatus text="Total itens:"/>
          <ObjectNumber number="{dlg>/totalItens}"/>
          <ToolbarSeparator/>
          <ObjectStatus text="Total materiais/serviços:"/>
          <ObjectNumber number="{path:'dlg>/totalValor', formatter:'.formatter.fmtBrl'}"/>
        </Toolbar>

        <Text text="Sem materiais para este veículo no período"
              visible="{= ${dlg>/materiais}.length === 0 }"/>
      </VBox>
    </content>

    <buttons>
      <Button text="Exportar CSV" type="Emphasized"
              press=".onExportMateriais"
              enabled="{= ${dlg>/materiais}.length > 0 }"/>
      <Button text="Imprimir"
              press=".onPrintMateriais"
              enabled="{= ${dlg>/materiais}.length > 0 }"/>
      <Button text="Fechar" type="Transparent" press=".onCloseMateriais"/>
    </buttons>
  </Dialog>
</core:FragmentDefinition>
