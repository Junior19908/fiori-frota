<mvc:View
  controllerName="com.skysinc.frota.frota.controller.Main"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
  xmlns:core="sap.ui.core"
  xmlns:table="sap.ui.table"
  displayBlock="true">

  <Page id="page" showHeader="false">
    <content>

      <!-- Barra superior: titulo -->
      <OverflowToolbar>
        <core:Icon src="sap-icon://car-rental" size="1.5rem"/>
        <Title text="Gestao de Frota" level="H3"/>
        <ToolbarSpacer/>
        <Button
          id="btnNotifications"
          icon="sap-icon://bell"
          type="Transparent"
          tooltip="{i18n>notif.tooltip}"
          press=".onOpenNotifications"
          ariaHasPopup="Dialog"
          text="{= ${notifModel>/unread} > 0 ? ${notifModel>/unread} : '' }">
          <layoutData>
            <OverflowToolbarLayoutData priority="High"/>
          </layoutData>
        </Button>
      </OverflowToolbar>

      <HBox class="sapUiSmallMarginBottom" justifyContent="SpaceBetween">
        <HBox renderType="Bare">
          <Label text="{i18n>filter.categories}" labelFor="filterCategories"/>
          <MultiComboBox id="filterCategories"
            width="18rem"
            items="{
              path: '/lists/categories'
            }"
            selectionFinish=".onFilterChanged">
            <core:Item key="{key}" text="{text}" />
          </MultiComboBox>

          <Label text="{i18n>filter.vehicles}" labelFor="filterVehicles" class="sapUiTinyMarginBegin"/>
          <MultiComboBox id="filterVehicles"
            width="18rem"
            items="{
              path: '/lists/vehicles'
            }"
            selectionFinish=".onFilterChanged">
            <core:Item key="{key}" text="{text}" />
          </MultiComboBox>

          <Label text="{i18n>filter.period}" labelFor="filterDateRange" class="sapUiTinyMarginBegin"/>
          <DateRangeSelection id="filterDateRange"
            displayFormat="dd/MM/yyyy"
            change=".onFilterChanged"/>
        </HBox>

        <HBox renderType="Bare">
          <Button id="btnClearFilters" type="Transparent" text="{i18n>filter.clear}" press=".onClearFilters"/>
          <Button id="btnConfigFilters" type="Transparent" icon="sap-icon://action-settings" text="{i18n>filter.config}" press=".onOpenFilterConfig"/>
        </HBox>
      </HBox>

      <!-- KPIs -->
      <OverflowToolbar width="100%">
        <ObjectStatus text="Gasto em combustivel" icon="sap-icon://expense-report" state="Information"/>
        <ObjectNumber number="{kpi>/gastoCombustivelFmt}" state="Information"/>
        <ToolbarSeparator/>
        <ObjectStatus text="Litros totais" icon="sap-icon://measure" state="Warning"/>
        <ObjectNumber number="{kpi>/totalLitrosFmt}" state="Warning"/>
        <ToolbarSeparator/>
        <ObjectStatus text="Custo material/servico" icon="sap-icon://wrench" state="Success"/>
        <ObjectNumber number="{kpi>/custoMateriaisFmt}" state="Success"/>
        <ToolbarSeparator/>
        <ObjectStatus text="Preco medio" icon="sap-icon://expense-report" state="None"/>
        <ObjectNumber number="{kpi>/precoMedioFmt}" unit="R$/L" state="None"/>
      </OverflowToolbar>

      <!-- Tabela principal -->
      <table:Table
          id="tbl"
          selectionMode="None"
          visibleRowCountMode="Auto"
          minAutoRowCount="5"
          alternateRowColors="true"
          enableColumnReordering="true"
          fixedColumnCount="4"
          width="100%"
          noData="Sem dados para o periodo/filtragem."
          rows="{vm>/veiculos}">

        <table:columns>

          <table:Column sortProperty="equnr" width="7rem">
            <Label text="Veiculo"/>
            <table:template>
              <HBox alignItems="Center" justifyContent="Start" renderType="Bare">
                <Text text="{vm>equnr}"/>
                <ObjectStatus
                  visible="{= ${vm>breakPreventiveRecommended} ? true : false }"
                  text="PREVENTIVA RECOMENDADA"
                  state="Error"
                  class="sapUiTinyMarginBegin"/>
              </HBox>
            </table:template>
          </table:Column>

          <table:Column sortProperty="CATEGORIA" width="10rem">
            <Label text="Categoria"/>
            <table:template>
              <Text text="{vm>CATEGORIA}"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="eqktx" width="10rem">
            <Label text="Descricao do Veiculo"/>
            <table:template>
              <Text text="{vm>eqktx}" maxLines="2"/>
            </table:template>
          </table:Column>

          <table:Column width="8rem" hAlign="Center">
            <Label text="Acoes"/>
            <table:template>
              <HBox alignItems="Center" justifyContent="Center">
                <Button icon="sap-icon://detail-view" type="Transparent" tooltip="Materiais/servicos" press=".onOpenMateriais"/>
                <Button icon="sap-icon://mileage" type="Transparent" tooltip="Abastecimentos" press=".onOpenAbastecimentos"/>
                <Button icon="sap-icon://enablement" type="Transparent" tooltip="Ordens de servico" press=".onOpenOSDialog"/>
                <Button icon="sap-icon://insurance-car" type="Transparent" tooltip="Historico" press=".onOpenHistorico"/>
              </HBox>
            </table:template>
          </table:Column>

          <!-- Agregados do periodo -->
          <table:Column sortProperty="totalValor" width="7rem" hAlign="End">
            <Label text="Custo material/servico (R$)"/>
            <table:template>
              <Text text="{ path: 'vm>totalValor', formatter: '.formatter.currencyBRL' }"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="combustivelLitrosAgg" width="7rem" hAlign="End">
            <Label text="Combustivel (L)"/>
            <table:template>
              <Text text="{path:'vm>combustivelLitrosAgg', formatter:'.formatter.fmtLitros'}"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="combustivelValorAgg" width="7rem" hAlign="End">
            <Label text="Combustivel (R$)"/>
            <table:template>
              <Text text="{path:'vm>combustivelValorAgg', formatter:'.formatter.fmtBrl'}"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="totalValorAgg" width="7rem" hAlign="End">
            <Label text="Custo servico (R$)"/>
            <table:template>
              <Text text="{path:'vm>totalValorAgg', formatter:'.formatter.fmtBrl'}"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="custoTotalAgg" width="7rem" hAlign="End">
            <Label text="Custo total (R$)"/>
            <table:template>
              <Text text="{
                parts:['vm>totalValor','vm>combustivelValorAgg'],
                formatter: '.formatter.fmtSomaBrl'
              }"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="kmRodadosAgg" width="6rem" hAlign="End">
            <Label text="Km rodados"/>
            <table:template>
              <Text text="{path:'vm>kmRodadosAgg', formatter:'.formatter.fmtKm'}"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="hrRodadosAgg" width="6rem" hAlign="End">
            <Label text="Hr rodados"/>
            <table:template>
              <Text text="{path:'vm>hrRodadosAgg', formatter:'.formatter.fmtNum'}"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="Media (km/L)"/>
            <table:template>
              <Text text="{
                parts: ['vm>kmRodadosAgg', 'vm>combustivelLitrosAgg'],
                formatter: '.formatter.fmtKmPorLitro'
              }"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="Media (L/h)"/>
            <table:template>
              <Text text="{
                parts: ['vm>combustivelLitrosAgg', 'vm>hrRodadosAgg'],
                formatter: '.formatter.fmtLitrosPorHora'
              }"/>
            </table:template>
          </table:Column>

          <table:Column sortProperty="pctDisp" width="16rem" hAlign="Center">
            <Label
              text="Disponibilidade"
              tooltip="Disponibilidade (%) = 100 - Indisponibilidade (%). Indisponibilidade (%) = (Horas em OS / Total de horas do periodo) x 100."/>
            <table:template>
              <ObjectStatus
                text="{vm>disponibilidadeFmt}"
                state="{ path:'vm>pctDisp', formatter:'.formatter.stateDisponibilidade' }"
                tooltip="{
                  parts: [
                    { path: 'vm>pctDisp' },
                    { path: 'vm>pctIndisp' },
                    { path: 'vm>totalHorasPeriodo' },
                    { path: 'vm>totalHorasIndisponiveis' },
                    { path: 'vm>totalHorasDisponiveis' }
                  ],
                  formatter: '.formatter.fmtDisponibilidadeTooltip'
                }"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="Hr Paradas (Teste)"/>
            <table:template>
              <Text text="{vm>horasParadasFmt}"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="Numero de paradas"/>
            <table:template>
              <Text text="{vm>falhas}"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="MTBF"/>
            <table:template>
              <Text text="{vm>mtbfFmt}"/>
            </table:template>
          </table:Column>

          <table:Column width="6rem" hAlign="End">
            <Label text="MTTR"/>
            <table:template>
              <Text text="{vm>mttrFmt}"/>
            </table:template>
          </table:Column>

          <table:Column width="8rem" hAlign="End">
            <Label text="(KM) Quebra"/>
            <table:template>
              <ObjectStatus
				text="{parts: ['vm>kmRodadosAgg', 'vm>falhas'],
                formatter: '.formatter.fmtKmQuebra'}"/>
            </table:template>
          </table:Column>

          <table:Column width="8rem" hAlign="End">
            <Label text="(HR) Quebra"/>
            <table:template>
              <ObjectStatus
                text="{parts: ['vm>combustivelLitrosAgg', 'vm>falhas'],
                formatter: '.formatter.fmtHrQuebra'}"/>
            </table:template>
          </table:Column>

        </table:columns>
      </table:Table>
    </content>
  </Page>
</mvc:View>
