<mvc:View
  controllerName="com.skysinc.frota.frota.controller.HistoricalPage"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
  xmlns:core="sap.ui.core"
  xmlns:html="http://www.w3.org/1999/xhtml"
  xmlns:uxap="sap.uxap"
  xmlns:l="sap.ui.layout"
  xmlns:table="sap.ui.table"
  xmlns:viz="sap.viz.ui5.controls"
  xmlns:viz.data="sap.viz.ui5.data"
  xmlns:viz.feeds="sap.viz.ui5.controls.common.feeds"
  displayBlock="true">

  <uxap:ObjectPageLayout id="op"
                         useIconTabBar="false"
                         showTitleInHeaderContent="true">

    <uxap:headerTitle>
      <uxap:ObjectPageDynamicHeaderTitle>
        <uxap:expandedHeading>
          <HBox alignItems="Center" renderType="Bare" class="sapUiSmallMarginEnd">
            <Avatar src="{detail>/imageUrl}"
                    fallbackIcon="sap-icon://camera"
                    displaySize="L"
                    displayShape="Square"
                    tooltip="{= ${detail>/descricao} ? 'Foto de ' + ${detail>/descricao} : 'Sem foto cadastrada'}"
                    class="sapUiTinyMarginEnd"/>
            <VBox class="sapUiSmallMarginEnd">
              <HBox alignItems="Center" renderType="Bare">
              <core:Icon src="sap-icon://insurance-car" size="1.5rem"/>
              <Title text="{= 'Historico do Veiculo ' + (${detail>/veiculo} || '')}" level="H3" class="sapUiTinyMarginBegin"/>
              <GenericTag value="{= ${detail>/categoria} || 'Nao informado' }"
                          design="StatusIconHidden"
                          status="Success"
                          class="sapUiTinyMarginBegin"/>
              <GenericTag value="{= ${detail>/manutencaoTexto} || 'Operacional' }"
                          design="StatusIconHidden"
                          status="{detail>/manutencaoState}"
                          class="sapUiTinyMarginBegin"/>
              </HBox>
              <Text text="{= ${detail>/descricao} || 'Sem descricao'}" class="sapUiTinyMarginTop"/>
              <HBox class="sapUiTinyMarginTop" alignItems="Center" renderType="Bare">
              <ObjectStatus text="{= 'Total OS: ' + (${detail>/countOs} || 0)}" state="Information"/>
              <ObjectStatus text="{= 'Servicos: ' + (${detail>/countServicos} || 0)}" state="Warning" class="sapUiTinyMarginBegin"/>
              <ObjectStatus text="{= 'Materiais: ' + (${detail>/countMateriais} || 0)}" state="Success" class="sapUiTinyMarginBegin"/>
              <ObjectStatus text="{= 'Combustiveis: ' + (${detail>/countComb} || 0)}" state="None" class="sapUiTinyMarginBegin"/>
              </HBox>
            </VBox>
          </HBox>
        </uxap:expandedHeading>
        <uxap:snappedHeading>
          <HBox alignItems="Center" renderType="Bare">
            <Avatar src="{detail>/imageUrl}"
                    fallbackIcon="sap-icon://camera"
                    displaySize="S"
                    displayShape="Square"
                    tooltip="{= ${detail>/descricao} ? 'Foto de ' + ${detail>/descricao} : 'Sem foto cadastrada'}"
                    class="sapUiTinyMarginEnd"/>
            <core:Icon src="sap-icon://insurance-car" size="1.25rem"/>
            <Title text="{= (${detail>/veiculo} || '') + ' - Historico'}" level="H4" class="sapUiTinyMarginBegin"/>
            <ObjectStatus text="{detail>/manutencaoTexto}" state="{detail>/manutencaoState}" class="sapUiTinyMarginBegin"/>
          </HBox>
        </uxap:snappedHeading>
      </uxap:ObjectPageDynamicHeaderTitle>
    </uxap:headerTitle>

    <uxap:headerContent>
      <HBox alignItems="Start"
            justifyContent="SpaceBetween"
            class="sapUiSmallMarginBottom"
            width="100%">
        <VBox>
          <ObjectStatus text="Resumo" state="None"/>
          <Text text="{= 'Veiculo: ' + (${detail>/veiculo} || 'Nao informado')}"/>
          <Text text="{= 'Categoria: ' + (${detail>/categoria} || 'Nao informado')}"/>
          <Text text="{= 'Descricao: ' + (${detail>/descricao} || 'Sem descricao')}"/>
          <Text text="{= 'Localizacao: ' + (${detail>/localInstalacao} || 'Nao informada')}" wrapping="true"/>
          <Text text="{detail>/localInstalacaoSec}"
                wrapping="true"
                visible="{= !!${detail>/localInstalacaoSec}}"
                class="sapUiTinyMarginTop"/>
        </VBox>
        <VBox class="sapUiTinyMarginBegin">
          <ObjectStatus text="Disponibilidade" state="{detail>/manutencaoState}"/>
          <Text text="{= 'Status atual: ' + (${detail>/manutencaoTexto} || 'Operacional')}"/>
          <Text text="{= 'OS em andamento: ' + (${detail>/countOs} || 0)}"/>
          <Text text="{= 'Servicos: ' + (${detail>/countServicos} || 0)}"/>
        </VBox>
        <VBox class="sapUiTinyMarginBegin">
          <ObjectStatus text="Totais" state="Information"/>
          <Text text="{= 'Total geral: ' + (${detail>/totalGeralFmt} || '-')}"/>
          <Text text="{= 'Materiais: ' + (${detail>/totalMateriaisFmt} || '-')}"/>
          <Text text="{= 'Combustiveis: ' + (${detail>/totalCombustivelFmt} || '-')}"/>
        </VBox>
      </HBox>
    </uxap:headerContent>

    <uxap:sections>
      <uxap:ObjectPageSection title="Historico Completo">
        <uxap:subSections>
          <uxap:ObjectPageSubSection title="Linha do tempo de custos">
            <uxap:blocks>
              <l:DynamicSideContent id="dsc"
                                    showSideContent="true"
                                    sideContentVisibility="AlwaysShow"
                                    containerQuery="true"
                                    equalSplit="false">

                <!-- CONTEUDO PRINCIPAL -->
                <l:mainContent>
                  <VBox class="sapUiSmallMargin sapUiResponsiveContentPadding">

                    <!-- ===== Filtros do historico ===== -->
                    <OverflowToolbar>
                      <Text text="Periodo:"/>
                      <DateRangeSelection id="drsHist"
                                          displayFormat="long"
                                          width="17rem"
                                          dateValue="{hfilter>/d1}"
                                          secondDateValue="{hfilter>/d2}"
                                          change=".onFilterChangeHist"/>
                      <ToolbarSeparator/>
                      <Text text="Tipo:"/>
                                            <ComboBox id="tipoHist"
                                width="12rem"
                                selectedKey="{hfilter>/tipo}"
                                selectionChange=".onFilterChangeHist">
                        <items>
                          <core:Item key="__ALL__" text="Todos"/>
                          <core:Item key="Combustivel" text="Combustivel"/>
                          <core:Item key="Material" text="Material"/>
                          <core:Item key="Servico" text="Servico"/>
                          <core:Item key="OS" text="OS"/>
                        </items>
                      </ComboBox>
                      <ToolbarSeparator/>
                      <SearchField id="qHist"
                                   width="20rem"
                                   placeholder="Buscar Descricao…"
                                   value="{hfilter>/q}"
                                   liveChange=".onFilterChangeHist"/>
                      <ToolbarSpacer/>
                      <Button text="Limpar" type="Transparent" press=".onClearHistFilters"/>
                    </OverflowToolbar>
                    <!-- ================================ -->

                    <IconTabBar id="historicalTabs"
                                expandable="false"
                                class="sapUiResponsiveContentPadding sapUiMediumMarginTop"
                                select=".onHistoricoTabSelect">
                      <items>
                        <!-- ABA: COMBUSTIVEIS -->
                        <IconTabFilter text="Combustiveis" icon="sap-icon://mileage">
                          <table:Table id="tblCombustiveis"
                                       rows="{path:'detail>/historicoComb'}"
                                       visibleRowCountMode="Auto"
                                       minAutoRowCount="8"
                                       selectionMode="None"
                                       width="100%"
                                       alternateRowColors="true">
                            <table:columns>
                              <table:Column sortProperty="data" width="6rem">
                                <Label text="Data"/>
                                <table:template>
                                  <Text text="{path:'detail>data', formatter:'.formatter.fmtDate'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="descricao" width="7rem">
                                <Label text="Descricao"/>
                                <table:template>
                                  <Text text="{detail>descricao}" wrapping="true" tooltip="{detail>descricao}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="qtde" width="7rem" hAlign="End">
                                <Label text="Litros"/>
                                <table:template>
                                  <Text text="{path:'detail>qtde', formatter:'.formatter.fmtNum'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="custoUnit" width="7rem" hAlign="End">
                                <Label text="Preco medio"/>
                                <table:template>
                                  <Text text="{path:'detail>custoUnit', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="valor" width="10rem" hAlign="End">
                                <Label text="Total (R$)"/>
                                <table:template>
                                  <Text text="{path:'detail>valor', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                            </table:columns>
                          </table:Table>
                        </IconTabFilter>

                        <!-- ABA: MATERIAIS -->
                        <IconTabFilter text="Materiais" icon="sap-icon://sales-order-item">
                          <table:Table id="tblMateriais"
                                       rows="{path:'detail>/historicoMateriais'}"
                                       visibleRowCountMode="Auto"
                                       minAutoRowCount="8"
                                       selectionMode="None"
                                       width="100%"
                                       alternateRowColors="true">
                            <table:columns>
                              <table:Column sortProperty="data" width="6rem">
                                <Label text="Data"/>
                                <table:template>
                                  <Text text="{path:'detail>data', formatter:'.formatter.fmtDate'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="descricao" width="22rem">
                                <Label text="Descricao"/>
                                <table:template>
                                  <Text text="{detail>descricao}" wrapping="true" tooltip="{detail>descricao}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="qtde" width="7rem" hAlign="End">
                                <Label text="Qtde"/>
                                <table:template>
                                  <Text text="{path:'detail>qtde', formatter:'.formatter.fmtNum'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="custoUnit" width="10rem" hAlign="End">
                                <Label text="Custo Unit."/>
                                <table:template>
                                  <Text text="{path:'detail>custoUnit', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="valor" width="10rem" hAlign="End">
                                <Label text="Total (R$)"/>
                                <table:template>
                                  <Text text="{path:'detail>valor', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                            </table:columns>
                          </table:Table>
                        </IconTabFilter>

                        <!-- ABA: SERVICOS -->
                        <IconTabFilter text="Servicos" icon="sap-icon://wrench">
                          <table:Table id="tblServicos"
                                       rows="{path:'detail>/historicoServicos'}"
                                       visibleRowCount="12"
                                       selectionMode="None"
                                       width="100%"
                                       alternateRowColors="true">
                            <table:columns>
                              <table:Column sortProperty="data" width="6rem">
                                <Label text="Data"/>
                                <table:template>
                                  <Text text="{path:'detail>data', formatter:'.formatter.fmtDate'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="descricao" width="22rem">
                                <Label text="Descricao"/>
                                <table:template>
                                  <Text text="{detail>descricao}" wrapping="true" tooltip="{detail>descricao}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="qtde" width="5rem" hAlign="End">
                                <Label text="Qtde"/>
                                <table:template>
                                  <Text text="{path:'detail>qtde', formatter:'.formatter.fmtNum'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="custoUnit" width="7rem" hAlign="End">
                                <Label text="Custo Unit."/>
                                <table:template>
                                  <Text text="{path:'detail>custoUnit', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="valor" width="7rem" hAlign="End">
                                <Label text="Total (R$)"/>
                                <table:template>
                                  <Text text="{path:'detail>valor', formatter:'.formatter.fmtBrl'}"/>
                                </table:template>
                              </table:Column>
                            </table:columns>
                          </table:Table>
                        </IconTabFilter>
                        <IconTabFilter text="OS" icon="sap-icon://activity-items" count="{detail>/countOs}">
                          <table:Table id="tblOS"
                                       rows="{path:'detail>/historicoOs'}"
                                       visibleRowCount="12"
                                       selectionMode="None"
                                       width="100%"
                                       alternateRowColors="true">
                            <table:columns>
                              <table:Column sortProperty="ordem" width="6rem">
                                <Label text="OS"/>
                                <table:template>
                                  <Text text="{detail>ordem}" tooltip="{detail>ordem}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="descricao" width="22rem">
                                <Label text="Descricao"/>
                                <table:template>
                                  <Text text="{detail>descricao}" wrapping="true" tooltip="{detail>descricao}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="categoriaOs" width="10rem">
                                <Label text="Categoria"/>
                                <table:template>
                                  <Text text="{detail>categoriaOs}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="tipoManual" width="10rem">
                                <Label text="Tipo (manual)"/>
                                <table:template>
                                  <Text text="{detail>tipoManual}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="aberturaDt" width="12rem">
                                <Label text="Inicio"/>
                                <table:template>
                                  <Text text="{ parts: [ {path:'detail>aberturaData'}, {path:'detail>aberturaHora'} ], formatter: '.formatter.fmtDateTime' }"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="fechamentoDt" width="12rem">
                                <Label text="Fim"/>
                                <table:template>
                                  <Text text="{ parts: [ {path:'detail>fechamentoData'}, {path:'detail>fechamentoHora'} ], formatter: '.formatter.fmtDateTime' }"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="duracao" width="8rem" hAlign="End">
                                <Label text="Duracao (h)"/>
                                <table:template>
                                  <Text text="{path:'detail>duracao', formatter:'.formatter.fmtNum'}"/>
                                </table:template>
                              </table:Column>
                              <table:Column sortProperty="status" width="10rem">
                                <Label text="Status"/>
                                <table:template>
                                  <Text text="{detail>status}"/>
                                </table:template>
                              </table:Column>
                            </table:columns>
                          </table:Table>
                        </IconTabFilter>
                        <!-- ABA: MAPA -->
                        <IconTabFilter text="Mapa" icon="sap-icon://map" key="MAP">
                          <content>
                            <FlexBox direction="Row"
                                     wrap="Wrap"
                                     renderType="Bare"
                                     alignItems="Start"
                                     justifyContent="Start"
                                     class="sapUiMediumMarginTop sapUiMediumMarginBottom sapUiTinyPadding mapTabFlex">
                              

                              <VBox width="100%"
                                    renderType="Bare"
                                    class="sapUiSmallMarginBottom sapUiSmallMarginBegin mapWrapperBox">
                                <layoutData>
                                  <FlexItemData growFactor="1" minWidth="18rem"/>
                                </layoutData>
                                  <html:iframe
                                    id="map"
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d5756.219643894211!2d-36.06781338017521!3d-8.97217763904899!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x70730ee541d6cd3%3A0xa5671f8e5611a4b4!2sUsina%20Serra%20Grande!5e1!3m2!1spt-BR!2sbr!4v1761601511713!5m2!1spt-BR!2sbr"
                                    width="100%"
                                    height="480"
                                    style="border:0; border-radius: 8px;"
                                    allowfullscreen=""
                                    loading="lazy"
                                    referrerpolicy="no-referrer-when-downgrade"></html:iframe>
                              </VBox>
                            </FlexBox>
                          </content>
                        </IconTabFilter>
                      </items>
                    </IconTabBar>

                  </VBox>
                </l:mainContent>

                <!-- KPI LATERAL + GRAFICO COMPARATIVO COMPACTO -->
                <l:sideContent>
                  <VBox class="sapUiSmallMargin sapUiResponsiveContentPadding">

                    <!-- Grafico principal (tipo alternavel) -->
                    <VBox class="sapUiSmallMarginTop">
                      <Toolbar>
                        <Title text="Comparativo (Ano Atual x Ano Anterior)" level="H5"/>
                        <ToolbarSpacer/>
                        <SegmentedButton selectionChange=".onChartTypeChange" selectedKey="{history>/chartType}">
                          <items>
                            <SegmentedButtonItem key="column" text="Colunas"/>
                            <SegmentedButtonItem key="line" text="Linhas"/>
                          </items>
                        </SegmentedButton>
                        <Button icon="sap-icon://refresh" tooltip="Recalcular" press=".onRefresh"/>
                      </Toolbar>

                      <viz:VizFrame id="vf"
                                    uiConfig="{applicationSet:'fiori'}"
                                    vizType="{history>/chartType}"
                                    width="100%"
                                    height="420px">
                        <viz:dataset>
                          <viz.data:FlattenedDataset data="{history>/points}">
                            <viz.data:dimensions>
                              <viz.data:DimensionDefinition name="Mes" value="{history>label}"/>
                            </viz.data:dimensions>
                            <viz.data:measures>
                              <viz.data:MeasureDefinition name="Ano Atual" value="{history>current}"/>
                              <viz.data:MeasureDefinition name="Ano Anterior" value="{history>previous}"/>
                            </viz.data:measures>
                          </viz.data:FlattenedDataset>
                        </viz:dataset>

                        <viz:feeds>
                          <viz.feeds:FeedItem uid="valueAxis" type="Measure" values="Ano Atual,Ano Anterior"/>
                          <viz.feeds:FeedItem uid="categoryAxis" type="Dimension" values="Mes"/>
                        </viz:feeds>
                      </viz:VizFrame>

                      <viz:Popover id="vfPopover"/>
                      <HBox class="sapUiSmallMarginTop">
                        <ObjectStatus text="{history>/subtitle}" state="Information"/>
                      </HBox>
                    </VBox>
                  </VBox>
                </l:sideContent>

              </l:DynamicSideContent>
            </uxap:blocks>
          </uxap:ObjectPageSubSection>
        </uxap:subSections>
      </uxap:ObjectPageSection>
    </uxap:sections>

  </uxap:ObjectPageLayout>
</mvc:View>
