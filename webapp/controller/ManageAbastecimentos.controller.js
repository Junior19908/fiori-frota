sap.ui.define([
  "sap/ui/core/mvc/Controller",
  "sap/ui/model/json/JSONModel",
  "sap/m/MessageToast",
  "sap/ui/core/BusyIndicator",
  "sap/m/MessageBox"
], function (Controller, JSONModel, MessageToast, BusyIndicator, MessageBox) {
  "use strict";

  function pad2(n){ return String(n).padStart(2, "0"); }
  function normalizeMonth(s){ var m = String(s||"").trim(); var mm = m.match(/^(\d{4})-(\d{2})$/); return mm ? (mm[1]+"-"+mm[2]) : ""; }
  function flattenAbast(data){ var out = []; if (!data || !data.abastecimentosPorVeiculo) return out; Object.keys(data.abastecimentosPorVeiculo).forEach(function(veh){ var arr = Array.isArray(data.abastecimentosPorVeiculo[veh]) ? data.abastecimentosPorVeiculo[veh] : []; arr.forEach(function(ev, idx){ out.push(Object.assign({ veiculo: veh, _idx: idx }, ev)); }); }); out.sort(function(a,b){ var ta = new Date((a.data||"1970-01-01")+"T"+(a.hora||"00:00:00")).getTime(); var tb = new Date((b.data||"1970-01-01")+"T"+(b.hora||"00:00:00")).getTime(); return ta - tb; }); return out; }

  return Controller.extend("com.skysinc.frota.frota.controller.ManageAbastecimentos", {
    onInit: function () { this.getView().setModel(new JSONModel({ items: [], ym: "" }), "ab"); },
    onNavBack: function(){ try { this.getOwnerComponent().getRouter().navTo("settings"); } catch(_){} },
    onLoad: function(){ var ym = normalizeMonth(this.byId("inpMonth").getValue()); if (!ym) { MessageToast.show("Informe Mês YYYY-MM."); return; } var mm = ym.split("-"); var y = Number(mm[0]), m = Number(mm[1]); var that = this; BusyIndicator.show(0); var url1 = sap.ui.require.toUrl("com/skysinc/frota/frota/model/localdata/abastecimento/" + y + "/" + pad2(m) + "/abastecimentos.json"); var url2 = sap.ui.require.toUrl("com/skysinc/frota/frota/model/localdata/" + y + "/" + pad2(m) + "/abastecimentos.json"); jQuery.ajax({ url: url1, dataType: 'json', cache: false, success: function(local){ var items = flattenAbast(local); that.getView().getModel("ab").setData({ items: items, ym: ym }); MessageToast.show(items.length + " evento(s) carregado(s) (local)."); }, error: function(){ jQuery.ajax({ url: url2, dataType: 'json', cache: false, success: function(local){ var items = flattenAbast(local); that.getView().getModel("ab").setData({ items: items, ym: ym }); MessageToast.show(items.length + " evento(s) carregado(s) (local)."); }, error: function(){ MessageToast.show("Mês não encontrado."); } }); } }).always(function(){ BusyIndicator.hide(); }); },
    _getSelection: function(){ var tbl = this.byId("tblEvents"); var ctxs = tbl.getSelectedContexts(true); return ctxs.map(function (c) { return c.getObject && c.getObject(); }).filter(Boolean); },
    onDeleteSelected: function(){ var sel = this._getSelection(); if (!sel.length) { MessageToast.show("Selecione ao menos um evento."); return; } var model = this.getView().getModel("ab"); var data = model.getData(); var ym = data.ym || ""; var mm = ym.split("-"); var y = Number(mm[0]), m = Number(mm[1]); var toDelete = new Set(sel.map(function(e){ return String(e.veiculo||'')+"|"+String(e.idEvento||''); })); var items = Array.isArray(model.getProperty("/items")) ? model.getProperty("/items") : []; var kept = items.filter(function(ev){ var k = String(ev.veiculo||'')+"|"+String(ev.idEvento||''); return !toDelete.has(k); }); var map = {}; kept.forEach(function(ev){ var veh = String(ev.veiculo||''); if(!veh) return; if(!map[veh]) map[veh]=[]; map[veh].push(ev); }); var json = { abastecimentosPorVeiculo: map }; try { var blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); var fname = 'abastecimentos-' + String(y) + '-' + String(m).padStart(2,'0') + '.json'; a.href = url; a.download = fname; document.body.appendChild(a); a.click(); setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0); MessageToast.show("JSON atualizado gerado: " + fname); this.getView().getModel('ab').setProperty('/items', kept); } catch (e) { console.error(e); MessageToast.show("Falha ao gerar JSON."); } },
    onDeleteMonth: function(){ var ym = (this.getView().getModel("ab").getData().ym || "").trim(); if (!ym) { MessageToast.show("Informe/Carregue o mês."); return; } var mm = ym.split("-"); var y = Number(mm[0]), m = Number(mm[1]); var that = this; MessageBox.error("Tem certeza que deseja excluir TODO o mês " + ym + "?", { actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL], onClose: function (act) { if (act !== MessageBox.Action.OK) return; var json = { abastecimentosPorVeiculo: {} }; try { var blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); var fname = 'abastecimentos-' + String(y) + '-' + String(m).padStart(2,'0') + '.json'; a.href = url; a.download = fname; document.body.appendChild(a); a.click(); setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0); MessageToast.show("Arquivo vazio gerado: " + fname); that.getView().getModel("ab").setData({ items: [], ym: ym }); } catch (e) { console.error(e); MessageToast.show("Falha ao gerar JSON."); } } }); }
  });
});
